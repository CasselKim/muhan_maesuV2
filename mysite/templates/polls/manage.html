{% extends 'base.html' %}
{% block content %}
<div class="container mt-3">
    <div class='row justify-content-center mb-4'>
        <div class="tab-content col" id="nav-tabContent" style="border: 1px solid #999;">
            <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">
                <ul class="row nav nav-tabs mt-1" id="myTab" role="tablist">
                    <h4 class="col-md mt-1">전체 ALL</h4>
                    
                    <li class="col-md-2 nav-item px-0" role="presentation">
                        <button class="col-12 nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">개요</button>
                    </li>
                    <li class="col-md-2 nav-item px-0" role="presentation">
                        <button class="col-12 nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">히스토리</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                        <div class="row mx-1 mt-3">
                            <div class="col-2 updown">
                                <div><p2 class="average">{{account_state.total_profit_percent}}</p2>%</div>
                                <div>▲ <p2 class="average">{{account_state.total_profit}}</p2>￦</div>
                            </div>
                            <div class="col">
                                <div>총 자산 : <p2 class="average">{{account_state.total_balance}}</p2>￦</div>
                                <div>입금액 : <p2 class="average">{{account_state.total_deposit}}</p2>￦</div>
                            </div>
                            <div class="col">
                                <div>매수자본 : <p2 class="average">{{account_state.total_buy}}</p2>￦</div>
                                <div>보유현금 : <p2 class="average">{{account_state.total_cash}}</p2>￦</div>
                            </div>
                            <div class="col">
                                <div>매도횟수 : <p2 class="average">{{account_state.sell_count}}</p2>번</div>
                                <div>총평가손익 : <p2 class="average">{{account_state.total_profit}}</p2>￦</div>
                            </div>
                        </div>
                        <hr></hr>
                        <div style="float:right; position: relative; z-index:2;">
                            <button type="button" class="btn btn-primary" id="all_refresh">
                                <i class="fa fa-refresh"> refresh</i>
                            </button>
                        </div>
                        <div style="width: 100%; position: relative; height: 300px; z-index:1;" id="line_top_x"></div>
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">...</div>
                </div>          
            </div>
            {% if trade_per_coin %}
            {% for coin in trade_per_coin %}
                <div class="tab-pane fade" id="list-{{coin.ticker}}" role="tabpanel" aria-labelledby="list-{{coin.ticker}}-list">
                    <ul class="row nav nav-tabs mt-1">
                        <h4 class="col-md mt-1">{{coin.ticker_name}} {{coin.ticker}}</h4>
                        <div class="col-md"></div>
                    </ul>
                    <div>
                        <div class="row mx-1 mt-3">
                            <div class="col-2 updown" style="color:#ff0000;">
                                <div><p2 class="average">{{coin.coin_profit_percent}}</p2>%</div>
                                <div>▲ <p2 class="average">{{coin.coin_profit}}</p2>￦</div>
                            </div>
                            <div class="col">
                                <div>원금 : <p2 class="average">{{coin.principal}}</p2>￦</div>
                                <div>분할금액 : <p2 class="average">{{coin.split}}</p2>￦</div>
                            </div>
                            <div class="col">
                                <div>매수금액 : <p2 class="average">{{coin.average}}</p2>￦</div>
                                <div>평가금액 : <p2 class="average">지금api로 받아오는 실시간금액</p2>￦</div>
                            </div>
                            <div class="col">
                                <div>진행일 : <p2 class="average">{{coin.execution_count}}</p2>일</div>
                                <div>남은금액 : <p2 class="average">{{coin.remain}}</p2>￦</div>
                            </div>
                        </div>
                        <hr></hr>
                        <div style="float:right; position: relative; z-index:2;">
                            <button type="button" class="btn btn-primary" id="refresh_{{coin.ticker}}">
                                <i class="fa fa-refresh"> refresh</i>
                            </button>
                        </div>
                        <div style="width: 100%; position: relative; height: 300px; z-index:1;" id="chart_{{coin.ticker}}"></div>
                    </div>          
                </div>
            {% endfor %}
            {% endif %}
        </div>
        <div class="col-lg-4" style="border: 1px solid #999;">
            <div class="row justify-content-end mx-1">
                <p class="col text-start my-2">티커</p>
                <p class="col text-end my-2">수익률</p>
                <p class="col text-end my-2">진행도</p>
            </div>
            
            <hr class="my-1"></hr>
            <div class="list-group list-group-flush" id="list-tab" role="tablist">
                <a class="list-group-item list-group-item-action active" id="list-home-list" data-bs-toggle="list" href="#list-home" role="tab" aria-controls="list-home">
                    <div class="row me-auto">
                        <div class="col text-start">
                            <div>전체</div>
                            <div>ALL</div>
                        </div>
                        <div class="col text-end updown">
                            <div><p2 class="average">{{account_state.total_profit_percent}}</p2>%</div>
                            <div><p2 class="average">{{account_state.total_profit}}</p2>￦</div>
                        </div>
                        <div class="col text-end">
                            <p class="col mb-0">-</p>
                        </div>

                    </div>
                </a>
                {% if trade_per_coin %}
                {% for coin in trade_per_coin %}
                <input type="hidden" id="coinVar" value="{{ coin.ticker }}">
                <a class="list-group-item list-group-item-action" id="list-{{coin.ticker}}-list" data-bs-toggle="list" href="#list-{{coin.ticker}}" role="tab" aria-controls="list-{{coin.ticker}}">
                    <div class="row me-auto">
                        <div class="col text-start">
                            <div>{{coin.ticker_name}}</div>
                            <div>{{coin.ticker}}</div>
                        </div>
                        <div class="col text-end updown">
                            <div><p2 class="average">{{coin.coin_profit_percent}}</p2>%</div>
                            <div><p2 class="average">{{coin.coin_profit}}</p2>￦</div>
                        </div>
                        <div class="col text-end">
                            <div><p2 class="average">{{coin.execution_count}}</p2>%</div>
                            <div><p2 class="average">{{coin.execution_count}}</p2>￦</div>
                        </div>

                    </div>
                </a>
                {% endfor %}
                {% endif %} 
            </div>  
        </div>
    </div>
</div>
<script>
    var triggerTabList = [].slice.call(document.querySelectorAll('#myTab button'))
    triggerTabList.forEach(function (triggerEl) {
      var tabTrigger = new bootstrap.Tab(triggerEl)
      triggerEl.addEventListener('click', function (event) {
        event.preventDefault();
        tabTrigger.show();
      })
    })
</script>
<script>
    function average_formatting() {
        var averages = document.querySelectorAll('.average');
        averages.forEach(function(average) {
            var average_value = Number(average.innerHTML);
            
            average.innerHTML = average_value.toLocaleString();
        });
    };
    function upDownColoring() {
        var updowns = document.querySelectorAll('.updown');
        updowns.forEach(function(updown) {
            if(updown.innerHTML.indexOf('-')==-1){
                updown.style.color =  "#ff0000";
            }
            else{
                updown.style.color =  "#0000ff";
            }
        });
    };
    average_formatting();
    upDownColoring();
</script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', {'packages':['line']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {

        var data = new google.visualization.DataTable();
        data.addColumn('number', 'Day');
        data.addColumn('number', 'Guardians of the Galaxy');
        data.addColumn('number', 'The Avengers');
        data.addColumn('number', 'Transformers: Age of Extinction');

        data.addRows([
            [1,  37.8, 80.8, 41.8],
            [2,  30.9, 69.5, 32.4],
            [3,  25.4,   57, 25.7],
            [4,  11.7, 18.8, 10.5],
            [5,  11.9, 17.6, 10.4],
            [6,   8.8, 13.6,  7.7],
            [7,   7.6, 12.3,  9.6],
            [8,  12.3, 29.2, 10.6],
            [9,  16.9, 42.9, 14.8],
            [10, 12.8, 30.9, 11.6],
            [11,  5.3,  7.9,  4.7],
            [12,  6.6,  8.4,  5.2],
            [13,  4.8,  6.3,  3.6],
            [14,  4.2,  6.2,  3.4]
    ]);

    var options = {
        width: '100%',
        
        axes: {
        x: {
            0: {side: 'bottom'}
        }
        },
        legend : {
            position: 'none',
            textStyle: {
                color: 'blue', fontSize: 16
            }
        }
    };

    var chart = new google.charts.Line(document.getElementById('line_top_x'));
    chart.draw(data, google.charts.Line.convertOptions(options));

    var coins = document.querySelectorAll("#coinVar");
    

    $("[id^=refresh]").on('click', function(event){ 
        var id = $(this).attr("id");
        var ticker = id.replace("refresh_", "");
        var chart = new google.charts.Line(document.getElementById('chart_'+ticker));
        chart.draw(data, google.charts.Line.convertOptions(options));
    });

    $('#all_refresh').click(function() {
        var chart = new google.charts.Line(document.getElementById('line_top_x'));
        chart.draw(data, google.charts.Line.convertOptions(options));
    });



}
</script>
{% endblock %}